{% extends "SocialMedia/groupe/base_groupe.html" %}
{% load staticfiles %}
{% load widget_tweaks %}
{% block title %}{{ groupe.nom }} - Membres{% endblock %}
{% block contentGroupe %}
                        <!-- Filter Nav Start -->
                            <div class="filter--nav pb--50 clearfix">
                                <div class="filter--link float--left">
                                    <h2 class="h4"><a id="numMem" href="#navTop" class="btn-link">{{ nbMembers }} Membres.</a></h2>
                                </div>
                                <div class="filter--options float--right">
                                    <label>
                                        <span class="fs--14 ff--primary fw--500 text-darker">Show By :</span>

                                        <select name="membersfilter" class="form-control form-sm" data-trigger="selectmenu">
                                            <option value="last-active" selected>Last Active</option>
                                            <option value="new-registered">New Registerd</option>
                                            <option value="alphabetical">Alphabetical</option>
                                        </select>
                                    </label>
                                </div>
                            </div>
                            <!-- Filter Nav End -->

                            <!-- Member Items Start -->
                        {% if nbMembers != 0 %}
                            <div class="member--items">
                                <div id="requests" class="row">
                            {% for member in members %}
                                    <div class="col-sm-3 member{{ member.id }}">
                                        <!-- Member Item Start -->
                                        <div class="member--item online">
                                            <div class="img img-circle">
                                                <a href="{% url 'SocialMedia:getProfil' member.id %}" class="btn-link">
                                                    <img src="{{ member.photo_profil.image.url|default:'/media/SocialMedia/default.jpg' }}" style="max-height: 55px;height: 100px;" alt="">
                                                </a>
                                            </div>

                                            <div class="name" style="white-space: nowrap;">
                                                <h3 class="h6 fs--12">
                                                    <a href="{% url 'SocialMedia:getProfil' member.id %}" class="btn-link">{{ member }}</a>
                                                </h3>
                                            </div>

                                            <div class="activity" style="white-space: nowrap;">
                                                <p><i class="fa mr--8 fa-clock-o"></i>{{ member.user.last_login|safe|date:'M. d, y, g:i A' }}{{ member.user.last_login|default_if_none:"Non Connecté" }}</p>
                                            </div>

                                            <div class="actions" style="white-space: nowrap;">
                                                <ul class="nav">
                                                    <li>
                                                        <a style="padding: 0;" href="#" title="Mettre Porfil Admin" class="btn-lin" data-toggle="tooltip" data-placement="bottom">
                                                            <form id="makeAdmin" data-id="make admin" action="{% url 'SocialMedia:membresGroupe' groupe.id %}" method="POST">
                                                                {% csrf_token %}
                                                                    {% render_field formDemande.profil value=member.id %}
                                                                    {% render_field formDemande.action value=3 %}
                                                                <button type="submit" class="btn-link" ><i class="fa fa-user-circle-o" aria-hidden="true"></i></button>
                                                            </form>
                                                        </a>
                                                    </li>

                                                    <li>
                                                        <a  style="padding: 0;" href="#" title="Mettre Profil Moderateur" class="btn-link" data-toggle="tooltip" data-placement="bottom">
                                                            <form id="makeModerator" data-id="make Moderator" action="{% url 'SocialMedia:membresGroupe' groupe.id %}" method="POST">
                                                                {% csrf_token %}
                                                                    {% render_field formDemande.profil value=member.id %}
                                                                    {% render_field formDemande.action value=2 %}
                                                                    <button type="submit" class="btn-link" ><i class="fa fa-user" aria-hidden="true"></i></button>
                                                            </form>
                                                        </a>
                                                    </li>
                                                    <li>
                                                        <a  style="padding: 0;" href="#" title="Mettre Porfil Adherent" class="btn-link" data-toggle="tooltip" data-placement="bottom">
                                                            <form id="makeAdherent" data-id="make Adherent" action="{% url 'SocialMedia:membresGroupe' groupe.id %}" method="POST">
                                                                {% csrf_token %}
                                                                    {% render_field formDemande.profil value=member.id %}
                                                                    {% render_field formDemande.action value=1 %}
                                                                    <button type="submit" class="btn-link" ><i class="fa fa-user-o" aria-hidden="true"></i></button>
                                                            </form>
                                                        </a>
                                                    </li>
                                                    <li>
                                                        <a  style="padding: 0;" href="#" title="Supprimer Porfil" class="btn-link" data-toggle="tooltip" data-placement="bottom">
                                                            <form id="deleteMember" data-id="delete Member" action="{% url 'SocialMedia:membresGroupe' groupe.id %}" method="POST">
                                                                {% csrf_token %}
                                                                    {% render_field formDemande.profil value=member.id %}
                                                                    {% render_field formDemande.action value=0 %}
                                                                    <button type="submit" class="btn-link" ><i class="fa fa-user-times" aria-hidden="true"></i></button>
                                                            </form>
                                                        </a>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                            {% endfor %}
                                </div>
                            </div>
                                        <!-- Member Item End -->
                            {% else %}
                                <h2 class="h4 fw--700 widget--title">Aucun Member n'a été rejoindre le groupe.</h2>
                            {% endif %}
                                <div class="row text-center">
                                                            <img id="loadingImage" style="display: none; width: 100%; object-fit: contain;" class="img-rounded"  src="{% static 'SocialMedia/loading.gif' %}" />
                                </div>

                            <!-- Page Count Start -->
                            <div class="page--count pt--30">
                                <label class="ff--primary fs--14 fw--500 text-darker">
                                    <span>Viewing</span>
                                    {% if members.has_previous %}
                                        <button id="btfirst" href="?page=1" class="btn-link"><i class="fa fa-caret-left"></i><i class="fa fa-caret-left"></i></button>
                                        <button id="btprevious" page="{{ members.previous_page_number }}" class="btn-link"><i class="fa fa-caret-left"></i></button>
                                    {% else %}
                                        <button id="btfirst" href="1" class="btn-link"><i class="fa fa-caret-left"></i><i class="fa fa-caret-left"></i></button>
                                        <button id="btprevious" page="1" class="btn-link"><i class="fa fa-caret-left"></i></button>
                                    {% endif %}
                                        <input id="RequestsPageNum" type="number" name="page-count" value="{{ members.number }}" class="form-control form-sm">
                                    {% if demandesAmis.has_next %}
                                        <button id="btnext" page="{{ members.next_page_number }}" class="btn-link"><i class="fa fa-caret-right"></i></button>
                                        <button id="btlast" page="{{ members.paginator.num_pages }}" class="btn-link"><i class="fa fa-caret-right"></i><i class="fa fa-caret-right"></i></button>
                                    {% else %}
                                        <button id="btnext" page="{{ members.paginator.num_pages }}" class="btn-link"><i class="fa fa-caret-right"></i></button>
                                        <button id="btlast" page="{{ members.paginator.num_pages }}" class="btn-link"><i class="fa fa-caret-right"></i><i class="fa fa-caret-right"></i></button>
                                    {% endif %}
                                        <span id="numPages">{{ members.paginator.num_pages }}</span>

                                </label>
                            </div>
                            <!-- Page Count End -->


{% endblock %}

{% block scripts %}
    {{ block.super }}
<script>

	$('.profil_links_menu li').removeClass('active');
    $('.profil_links_menu li:eq(3)').addClass('active');
    setTimeout(function () {
    $('html, body').animate({
        scrollTop: $("#navTop").offset().top
    }, 500);
    }, 250);

        function printRequests(memberId, results)
    {
            profilURL = "{% url 'SocialMedia:getProfil' 999999 %}".replace(999999, memberId);
            profilfield = '{% render_field formDemande.profil value=999999 %}'.replace(999999, memberId);
            actionURL = "{% url 'SocialMedia:membresGroupe' 999999 %}".replace(999999, {{ groupe.id }});
            csrf = "{% csrf_token %}".replace(/'/g, '"');
            NewData = '<div class="col-sm-3 member'+memberId+'" >' +
            '<div class="member--item online">' +

                '<div class="img img-circle">' +
                '<a href="'+profilURL+'" class="btn-link"><img src="'+results.photo_profil+'" style="max-height: 55px;height: 100px;" alt=""></a>' +
                '</div>' +

            '<div class="name" style="white-space: nowrap;">' +
            '<h3 class="h6 fs--12">' +
            '<a href="'+profilURL+'" class="btn-link">'+results.username+'</a></h3>' +
            '</div>' +

                '<div class="activity" style="white-space: nowrap;"><p><i class="fa mr--8 fa-clock-o"></i>'+results.last_login+'</p></div>' +

                    '<div class="actions" >' +
                        '<ul class="nav"><li><a style="padding: 0;" href="#" title="Mettre Porfil Admin" class="btn-lin" data-toggle="tooltip" data-placement="bottom">' +
                        '<form id="makeAdmin" data-id="make Admin" action="'+actionURL+'" method="POST">'+csrf+profilfield+
                        '{% render_field formDemande.action value=3 %}'+
                        '<button type="submit" class="btn-link" ><i class="fa fa-user-circle-o" aria-hidden="true"></i></button>' +
                        '</form></a></li>' +
                        '<li><a style="padding: 0;" href="#" title="Mettre Porfil Moderateur" class="btn-link" data-toggle="tooltip" data-placement="bottom">' +
                        '<form id="makeModerator" data-id="make Moderator" action='+actionURL+' method="POST">'+csrf+profilfield+
                        '{% render_field formDemande.action value=2 %}'+
                        '<button type="submit" class="btn-link" ><i class="fa fa-user" aria-hidden="true"></i></button></form></a></li>' +
                        '<li><a style="padding: 0;" href="#" title="Mettre Porfil Adherent" class="btn-link" data-toggle="tooltip" data-placement="bottom">' +
                        '<form id="makeAdherent" data-id="make Adherent" action='+actionURL+' method="POST">'+csrf+profilfield+
                        '{% render_field formDemande.action value=1 %}'+
                        '<button type="submit" class="btn-link" ><i class="fa fa-user-o" aria-hidden="true"></i></button></form></a></li>' +
                        '<li><a style="padding: 0;" href="#" title="Supprimer Profil" class="btn-link" data-toggle="tooltip" data-placement="bottom">' +
                        '<form id="deleteMember" data-id="delete Member" action='+actionURL+' method="POST">'+csrf+profilfield+
                        '{% render_field formDemande.action value=0 %}'+
                        '<button type="submit" class="btn-link" ><i class="fa fa-user-times" aria-hidden="true"></i></button></form></a></li>' +
                        '</ul></div></div></div>';
           /* setTimeout(function(){
                    $("#requests").text(NewData);
                }, 1000);*/
           $("#requests").append(NewData);
           //console.log(demandeId);
           //console.log(NewData);
    }

    function getUserAjax(emetteur_id)
    {
        $.ajax({
            url: '{% url "SocialMedia:AjaxUser" %}',
            type: 'GET',
            data : {
                    'pid': emetteur_id
                   },
            dataType: 'json',
            success: function(data) {
                if( data.statut ) {
                        printRequests(emetteur_id, data);
                }else
                    {
                        swal({
                          type: 'error',
                          title: 'Erreur',
                          text: 'Veuiller actualiser la page puis ressayer',
                        })
                    }
            },
            error: function() {
                swal("Veuiller Verifier Votre Connexion Reseau Puis Ressayer", "Erreur Fatale", "error");
            },
            stop: function (e) {  /* 3. WHEN THE UPLOADING PROCESS FINALIZE, HIDE THE MODAL */

            }
        });
    }

	$('body').on( "submit","#makeAdmin, #makeModerator, #makeAdherent, #deleteMember", function(event) {
	event.preventDefault();
    var form_data = new FormData($(this)[0]);
    message = $(this).data('id');
    //console.log(message);
    $.ajax({
        url: '{% url "SocialMedia:membresGroupe" groupe.id %}',
        type: $(this).attr('method'),
        processData: false,
        contentType: false,
        data : form_data,
        success: function(data) {
            var i=1;
            if( data.statut ) {
                    if( data.nbMembers == 0)
                    {
                        $("#requests").html("<h2 class='h4 fw--700 widget--title'>Aucun Member n'a été rejoindre le groupe.</h2>");$("#RequestsPageNum").val('1');
                        $("#btfirst").hide(250);
                        $("#btnext").hide(250);
                        $("#btlast").hide(250);
                        $("#btnext").hide(250);
                        $("#btprevious").hide(250);
                        $("#nbMembersBadge").text(data.nbMembers);
                        $("#numMem").text(data.nbMembers+' Membres.');
                        const toast = swal.mixin({
                          toast: true,
                          position: 'top-end',
                          showConfirmButton: false,
                          timer: 3000
                        });
                        toast({
                          type: 'success',
                          title: data.message,
                        })
                    }else{
                        $('.member'+data.profil).fadeOut(250, function(){
                            $("#requests").fadeOut(250, function(){
                                $("#requests").fadeIn(500);
                            });
                            const toast = swal.mixin({
                              toast: true,
                              position: 'top-end',
                              showConfirmButton: false,
                              timer: 3000
                        });
                        toast({
                          type: 'success',
                          title: data.message,
                        });
                            getGroupeMembers($("#RequestsPageNum").val());
                            $("#nbMembersBadge").text(data.nbMembers);
                        });
                    }
            }else
                {
                    swal({
                      type: 'error',
                      title: 'Erreur',
                      text: 'Veuiller actualiser la page puis ressayer',
                    })
                }
        },
        complete: function()
        {

        },
        error: function() { },
        stop: function (e) {  /* 3. WHEN THE UPLOADING PROCESS FINALIZE, HIDE THE MODAL */
            swal("Veuiller Verifier Votre Connexion Reseau Puis Ressayer", "Erreur Fatale", "error");
        }
    });

});

    function getGroupeMembers(page)
    {
        $.ajax({
        url: '{% url "SocialMedia:membresGroupeViaAjax" groupe.id %}',
        data : {'page':page},
        dataType: 'json',
        success: function(data) {
            if( data.statut ) {
                var i=1;
                    if( data.nbMembers == 0)
                    {
                        $("#requests").html("<h2 class='h4 fw--700 widget--title'>Aucun Member n'a été rejoindre le groupe.</h2>");
                        $("#RequestsPageNum").val('1');
                        $("#btfirst").hide(250);
                        $("#btnext").hide(250);
                        $("#btlast").hide(250);
                        $("#btnext").hide(250);
                        $("#btprevious").hide(250);
                        $("#nbMembersBadge").text(data.nbMembers);
                        $("#numMem").text(data.nbMembers+' Membres.');
                    }else{
                        $("#loadingImage").fadeIn(350);
                            $('#requests').empty();
                            setTimeout(function () {
                            $.each(data.membersGroupe,function(key, value){
                                    getUserAjax(value.id);
                                    $("#NbMembres, #numMem").text(data.nbMembres+' Membres.');
                            });
                            },250);
                            $("#nbMembersBadge").text(data.nbMembers);
                            $("#numMem").text(data.nbMembers+' Membres.');
                            $("#btprevious").attr('page', data.previous_page_number);
                            $("#btnext").attr('page', data.next_page_number);
                            $("#btlast").attr('page', data.num_pages);
                            $("#RequestsPageNum").val(data.current_page);
                            $("#numPages").text(data.num_pages);
                            if( !data.has_next )
                            {
                                $("#btnext").hide(250);
                                $("#btlast").hide(250);
                            }else
                            {
                                $("#btnext").show(250);
                                $("#btlast").show(250);
                            }

                            if( !data.has_previous )
                            {
                                $("#btprevious").hide(250);
                                $("#btfirst").hide(250);
                            }else
                            {
                                $("#btprevious").show(250);
                                $("#btfirst").show(250);
                            }

                            if( data.NumPagesExcessed )
                            {
                                $("#RequestsPageNum").text(data.num_pages);
                            }

                    }
            }else
                {
                    swal({
                      type: 'error',
                      title: 'Erreur',
                      text: 'Veuiller actualiser la page puis ressayer',
                    })
                }
        },
        complete: function()
        {
            $("#loadingImage").fadeOut(50);
            $('html, body').animate({
              scrollTop: $("#navTop").offset().top
            }, 500)
        },
        error: function() { },
        stop: function (e) {  /* 3. WHEN THE UPLOADING PROCESS FINALIZE, HIDE THE MODAL */
            swal("Veuiller Verifier Votre Connexion Reseau Puis Ressayer", "Erreur Fatale", "error");
        }
    });
    }

    $("body").on('click', '#btfirst, #btprevious, #btnext, #btlast', function(event){
        event.preventDefault();
        pagenum=$(this).attr('page');
        getGroupeMembers(pagenum);
    });

    $('#RequestsPageNum').on('keypress', function(e) {
        if(e.which == 13) {
         pageNum = $(this).val();
         getGroupeMembers(pageNum);
        }
    });



</script>
{% endblock %}



